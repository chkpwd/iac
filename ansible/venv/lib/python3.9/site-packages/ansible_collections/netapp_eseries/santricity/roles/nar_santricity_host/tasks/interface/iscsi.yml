- name: "{{'Configure' if (eseries_remove_all_configuration_state | default('present')) == 'present' else 'Unconfigure' }} controller A inventory-defined controller port definitions for iSCSI"
  na_santricity_iscsi_interface:
    ssid: "{{ current_eseries_ssid }}"
    api_url: "{{ current_eseries_api_url }}"
    api_username: "{{ current_eseries_api_username }}"
    api_password: "{{ current_eseries_api_password }}"
    validate_certs: "{{ current_eseries_validate_certs | default(omit) }}"
    state: "{{ item['state'] | default(eseries_controller_iscsi_port_state | default(omit)) }}"
    port: "{{ port + 1 }}"
    controller: A
    config_method: "{{ item['config_method'] | default(eseries_controller_iscsi_port_config_method | default(omit)) }}"
    address: "{{ item['address'] | default(omit) }}"
    gateway: "{{ item['gateway'] | default(eseries_controller_iscsi_port_gateway | default(omit)) }}"
    subnet_mask: "{{ item['subnet_mask'] | default(eseries_controller_iscsi_port_subnet_mask | default(omit)) }}"
    mtu: "{{ item['mtu'] | default(eseries_controller_iscsi_port_mtu | default(omit)) }}"
    speed: "{{ item['speed'] | default(eseries_controller_iscsi_port_speed | default(omit)) }}"
  loop: "{{ lookup('list', eseries_controller_iscsi_port['controller_a']) }}"
  loop_control:
    index_var: port
  when: eseries_controller_iscsi_port is defined and eseries_controller_iscsi_port['controller_a'] is defined

- name: "{{'Configure' if (eseries_remove_all_configuration_state | default('present')) == 'present' else 'Unconfigure' }} controller B inventory-defined controller port definitions for iSCSI"
  na_santricity_iscsi_interface:
    ssid: "{{ current_eseries_ssid }}"
    api_url: "{{ current_eseries_api_url }}"
    api_username: "{{ current_eseries_api_username }}"
    api_password: "{{ current_eseries_api_password }}"
    validate_certs: "{{ current_eseries_validate_certs | default(omit) }}"
    state: "{{ item['state'] | default(eseries_controller_iscsi_port_state | default(omit)) }}"
    port: "{{ port + 1 }}"
    controller: B
    config_method: "{{ item['config_method'] | default(eseries_controller_iscsi_port_config_method | default(omit)) }}"
    address: "{{ item['address'] | default(omit) }}"
    gateway: "{{ item['gateway'] | default(eseries_controller_iscsi_port_gateway | default(omit)) }}"
    subnet_mask: "{{ item['subnet_mask'] | default(eseries_controller_iscsi_port_subnet_mask | default(omit)) }}"
    mtu: "{{ item['mtu'] | default(eseries_controller_iscsi_port_mtu | default(omit)) }}"
    speed: "{{ item['speed'] | default(eseries_controller_iscsi_port_speed | default(omit)) }}"
  loop: "{{ lookup('list', eseries_controller_iscsi_port['controller_b']) }}"
  loop_control:
    index_var: port
  when: eseries_controller_iscsi_port is defined and eseries_controller_iscsi_port['controller_b'] is defined

- name: "{{'Configure' if (eseries_remove_all_configuration_state | default('present')) == 'present' else 'Unconfigure' }} iSCSI discovery parameters"
  na_santricity_iscsi_target:
    ssid: "{{ current_eseries_ssid }}"
    api_url: "{{ current_eseries_api_url }}"
    api_username: "{{ current_eseries_api_username }}"
    api_password: "{{ current_eseries_api_password }}"
    validate_certs: "{{ current_eseries_validate_certs | default(omit) }}"
    name: "{{ eseries_iscsi_target_name | default(omit) }}"
    chap_secret: "{%- if eseries_iscsi_target_chap_secret_update %}{{ eseries_iscsi_target_chap_secret }}{%- endif %}"
    ping: "{{ eseries_iscsi_target_ping | default(omit) }}"
    unnamed_discovery: "{{ eseries_iscsi_target_unnamed_discovery | default(omit) }}"
  when: ((eseries_iscsi_target_chap_secret is defined and eseries_iscsi_target_chap_secret_update) or
         eseries_iscsi_target_name is defined or eseries_iscsi_target_ping is defined or
         eseries_iscsi_target_unnamed_discovery is defined)
