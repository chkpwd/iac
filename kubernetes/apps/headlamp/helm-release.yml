---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/common-3.1.0/charts/library/common/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headlamp
spec:
  interval: 15m
  chart:
    spec:
      chart: headlamp
      version: 0.30.1
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: headlamp
        namespace: flux-system
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    fullnameOverride: headlamp
    config:
      pluginsDir: /build/plugins
    initContainers:
      - name: cert-manager-plugin
        image: node:23-alpine3.21
        command:
          - /bin/sh
          - -c
          - |
            apk add --no-cache git
            git clone https://github.com/Faakhir30/headlamp.git /tmp/headlamp/
            cd /tmp/headlamp
            git checkout batch_plugin_support
            cd plugins/headlamp-plugin
            npm install
            bin/headlamp-plugin.js install --source https://artifacthub.io/packages/headlamp/headlamp-plugins/headlamp_cert-manager --folderName cert-manager
            bin/headlamp-plugin.js install --source https://artifacthub.io/packages/headlamp/headlamp-plugins/headlamp_flux --folderName flux
            mkdir -p /build/plugins/cert-manager /build/plugins/flux
            cp -r /tmp/headlamp/plugins/headlamp-plugin/cert-manager/headlamp_cert-manager/* /build/plugins/cert-manager
            cp -r /tmp/headlamp/plugins/headlamp-plugin/flux/headlamp_flux/* /build/plugins/flux
        volumeMounts:
          - mountPath: /build/plugins
            name: plugins
    volumeMounts:
      - mountPath: /build/plugins
        name: plugins
    volumes:
      - name: plugins
        emptyDir: {}
    persistentVolumeClaim:
      enabled: false
    ingress:
      enabled: true
      ingressClassName: int-ingress
      hosts:
        - host: headlamp.chkpwd.com
          paths:
            - path: /
              type: ImplementationSpecific
    extraManifests:
      - |
        apiVersion: v1
        kind: Secret
        type: kubernetes.io/service-account-token
        metadata:
          name: {{ include "headlamp.fullname" . }}-admin-token
          namespace: {{ .Release.Namespace }}
          annotations:
            kubernetes.io/service-account.name: {{ include "headlamp.serviceAccountName" . }}
  # postRenderers:
  #   - kustomize:
  #       patches:
  #         - target:
  #             group: rbac.authorization.k8s.io
  #             version: v1
  #             kind: ClusterRoleBinding
  #             name: headlamp-admin
  #           patch: |
  #             - op: add
  #               path: /subjects/-
  #               value:
  #                 kind: Group
  #                 name: Admins
  #                 apiGroup: rbac.authorization.k8s.io
