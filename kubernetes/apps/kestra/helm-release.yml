---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kestra
spec:
  interval: 15m
  chart:
    spec:
      chart: kestra
      version: 0.22.4
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: kestra
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: -1
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      image: kestra/kestra
      pullPolicy: IfNotPresent
    # configuration:
    #   kestra:
    #     plugins:
    #       configurations:
    #         - type:  io.kestra.plugin.scripts.runner.docker.Docker
    #           values:
    #             volume-enabled: true
    externalSecret:
      secretName: kestra-secrets
      key: kestra_configuration
    executable: /app/kestra
    deployments:
      standalone:
        enabled: true
        kind: Deployment
        command: "server standalone{{ if $.Values.deployments.standalone.workerThreads }} --worker-thread={{ .Values.deployments.standalone.workerThreads }}{{ end }}"
        terminationGracePeriodSeconds: 60
        # By default, we start a number of threads of two times the number of available processors, use 'workerThreads' to configure a different value.
        #workerThreads: 128 # TODO: Look into this
    dind: # for io.kestra.core.tasks.scripts.Bash task or io.kestra.plugin.scripts.*
      enabled: false
    minio:
      enabled: false
    postgresql:
      enabled: false
    service:
      type: ClusterIP
      port: 8080
      management:
        enabled: false
        port: 8081
    extraENV:
      - name: JAVA_OPTS
        value: "-user.timezone=America/New_York"
      - name: DATASOURCES_POSTGRES_USERNAME
        valueFrom:
          secretKeyRef:
            name: kestra-pguser-kestra
            key: user
      - name: DATASOURCES_POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: kestra-pguser-kestra
            key: password
      - name: DATASOURCES_POSTGRES_URL
        value: "jdbc:postgresql://ketra-primary.runners.svc.cluster.local:5432/kestra"
      - name: DATASOURCES_POSTGRES_DRIVER-CLASS-NAME # camelCase transformation
        value: org.postgresql.Driver
      - name: KESTRA_SUPERADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: kestra-secrets
            key: admin_password
    securityContext:
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
    ingress:
      enabled: true
      className: int-ingress
      hosts:
        - host: kestra.chkpwd.com
          paths:
            - path: /
              pathType: Prefix
    extraVolumeMounts:
      - name: tmp
        mountPath: /tmp/kestra-wd/tmp
      - name: data
        mountPath: /app/storage
    extraVolumes:
      - name: tmp
        emptyDir: {}
      - name: data
        emptyDir: {}
    resources:
      requests:
        cpu: 250m
        memory: 1024Mi
      limits:
        memory: 4096Mi
    # https://kestra.io/docs/administrator-guide/configuration/others#kestravariablesenv-vars-prefix
    extraConfigMapEnvFrom: []
    extraSecretEnvFrom: []
