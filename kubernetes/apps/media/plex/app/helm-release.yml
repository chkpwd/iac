apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: plex
spec:
  interval: 15m
  chart:
    spec:
      chart: plex-media-server
      version: 0.6.0
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: plexinc
        namespace: flux-system

  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  values:
    fullnameOverride: "plex"

    image:
      registry: index.docker.io
      repository: plexinc/pms-docker
      tag: "1.41.3.9314-a0bfb8370"
      pullPolicy: IfNotPresent

    ingress:
      enabled: true
      ingressClassName: "int-ingress"
      url: "plex.${LOCAL_DOMAIN}"
      annotations:
        external-dns.alpha.kubernetes.io/target: ${LOCAL_DOMAIN}

    pms:
      configStorage: 20Gi
      storageClassName: longhorn-media
      resources:
        requests:
          gpu.intel.com/i915: 1
          cpu: 200m
          memory: 1Gi
        limits:
          gpu.intel.com/i915: 1
          memory: 2Gi


    statefulSet:
      podAnnotations:
        reloader.stakater.com/autoreload: "true"

    service:
      type: LoadBalancer
      port: 32400
      externalTrafficPolicy: Cluster
      annotations:
        lbipam.cilium.io/ips: "${PLEX_LB_ADDRESS}"

    nodeSelector:
      intel.feature.node.kubernetes.io/gpu: "true"

    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 80
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - jellyfin
                      - sabnzbd
              topologyKey: "kubernetes.io/hostname"

    extraEnv:
      PLEX_CLAIM:
        valueFrom:
          secretKeyRef:
            name: plex-secrets
            key: PLEX_CLAIM
      HOSTNAME: "plex-srv-01"
      TZ: "${TZ}"
      PLEX_UID: "1026"
      PLEX_GID: "100"
      ALLOWED_NETWORKS: "172.16.16.0/24"
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,video,utility"

    extraVolumeMounts:
      - name: data
        mountPath: /data

    extraVolumes:
      - name: data
        nfs:
          server: "nas-srv-01.${LOCAL_DOMAIN}"
          path: /volume1/vault-01/media
          readOnly: true
