---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: semaphore
spec:
  interval: 15m
  chart:
    spec:
      chart: semaphore
      version: 12.6.4
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: semaphore
        namespace: flux-system
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    replicaCount: 1
    annotations:
      reloader.stakater.com/auto: "true"
    image:
      repository: docker.io/semaphoreui/semaphore
      tag: v2.14.10
      pullPolicy: IfNotPresent
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
    extraEnvVariables:
      TZ: "America/New_York"
      ANSIBLE_HOST_KEY_CHECKING: false
      SEMAPHORE_PORT: &port 3000
      SEMAPHORE_ADMIN_NAME: "runner"
      SEMAPHORE_ADMIN_EMAIL: "authentik@chkpwd.com"
    billing:
      enabled: false
    email:
      enabled: false
    general:
      host: https://semaphore.chkpwd.com
      gitClient: cmd_git
      tmpPath: /tmp/semaphore
      maxParallelTasks: 0
      passwordLoginDisable: false
      nonAdminCanCreateProject: false
      useRemoteRunner: false
      sshConfigPath: ~/.ssh/config
      additionalPythonPackages: []
      tmp_path: /tmp/semaphore/
    secrets:
      accesskeyEncryptionKey: SEMAPHORE_ACCESS_KEY_ENCRYPTION
      cookieHashKey: COOKIE_HASH
      cookieEncryptionKey: COOKIE_ENCRYPTION
      existingSecret: semaphore
    postgresql:
      enabled: false
    mariadb:
      enabled: false
    database:
      type: bolt
    persistence:
      enabled: true
      storageClass: ceph-block
      size: 5G
      accessModes: ["ReadWriteOnce"]
    oidc:
      enable: true
      providers:
        authentik:
          display_name: Login with SSO
          provider_url: https://authentik.chkpwd.com/application/o/semaphore-ui/
          redirect_url: https://semaphore.chkpwd.com/api/auth/oidc/authentik/redirect
          username_claim: preferred_username
          name_claim: preferred_username
          email_claim: email
          client_id: semaphore
          client_secret: ${OAUTH2_CLIENT_SECRET}
    ldap:
      enable: false
    service:
      type: ClusterIP
      port: *port
      internalPort: *port
    ingress:
      enabled: true
      className: ext-ingress
      labels:
        external-dns/public: "true"
      annotations:
        external-dns.alpha.kubernetes.io/target: "chkpwd.com"
        nginx.ingress.kubernetes.io/limit-rpm: "30"
        nginx.ingress.kubernetes.io/limit-connections: "10"
        nginx.ingress.kubernetes.io/server-snippet: |
          location ^~ / {
            return 403;
          }
      hosts:
        - host: "{{ .Release.Name }}.chkpwd.com"
          paths:
            - path: /api/integrations
              pathType: Prefix
    resources:
      requests:
        cpu: 5m
        memory: 300Mi
      limits:
        memory: 1Gi
