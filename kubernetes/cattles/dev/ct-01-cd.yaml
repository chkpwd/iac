---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: &name ct-01-cd
  namespace: cattles
spec:
  runStrategy: RerunOnFailure
  template:
    metadata:
      labels:
        kubevirt.io/size: small
        kubevirt.io/domain: *name
    spec:
      domain:
        devices:
          disks:
            - disk:
                bus: virtio  # Type of disk bus
              name: containerdisk
            - disk:
                bus: virtio
              name: cloudinitdisk
            - name: emptydisk
              disk:
                bus: virtio
        resources:
          requests:
            memory: 100Mi
      volumes:
        - name: emptydisk
          emptyDisk:
            capacity: 100Mi # Capacity of the empty ephemeral disk
        - containerDisk:
            image: quay.io/kubevirt/alpine-container-disk-demo # The image used for the container disk
          name: containerdisk
        - cloudInitNoCloud: # Cloud-init configuration
            userData: | # User-data script
              #cloud-config
              preserve_hostname: true
              hostname: *name  # Sets the hostname
              fqdn: *name      # Fully Qualified Domain Name
              prefer_fqdn_over_hostname: true
              users:
                - default
                - name: hyoga
                  lock_passwd: true   # Locks the password
                  ssh_authorized_keys:
                    - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBK2VnKgOX7i1ISETheqjAO3/xo6D9n7QbWyfDAPsXwa"
              runcmd:
                - [ sh, -c, "hostnamectl set-hostname *name" ]  # Sets the hostname
                - [ sudo, yum, install, -y, qemu-guest-agent ]  # Installs qemu-guest-agent
                - [ sudo, systemctl, start, qemu-guest-agent ]  # Starts qemu-guest-agent
          name: cloudinitdisk
